<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ログイン＆新規登録（ローカルテキスト方式）</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .hidden { display: none; }
        .container { max-width: 350px; margin: 50px auto; }
        input, button, select { width: 100%; padding: 8px; margin: 5px 0; }
    </style>
</head>
<body>
<div class="container">
    <div id="loginDiv">
        <h2>ログイン</h2>
        <input type="file" id="loginFile" accept=".txt"><br>
        <input type="text" id="loginName" placeholder="お名前"><br>
        <input type="password" id="loginPw" placeholder="ログインパスワード"><br>
        <button onclick="login()">ログイン</button>
        <p>新規登録は <a href="#" onclick="showRegister()">こちら</a></p>
        <div id="loginMsg"></div>
    </div>
    <div id="registerDiv" class="hidden">
        <h2>新規登録</h2>
        <input type="file" id="regFile" accept=".txt"><br>
        <input type="text" id="regName" placeholder="お名前（3文字以上）"><br>
        <input type="password" id="regPw" placeholder="ログインパスワード（数字4桁以上）"><br>
        <button onclick="register()">登録してテキスト保存</button>
        <p>戻る場合は <a href="#" onclick="showLogin()">ログイン画面へ</a></p>
        <div id="regMsg"></div>
    </div>
    <div id="mypageDiv" class="hidden">
        <h2>マイページ</h2>
        <p id="userInfo"></p>
        <button onclick="logout()">ログアウト</button>
    </div>
</div>
<script>
function showRegister() {
    document.getElementById('registerDiv').classList.remove('hidden');
    document.getElementById('loginDiv').classList.add('hidden');
    document.getElementById('mypageDiv').classList.add('hidden');
}
function showLogin() {
    document.getElementById('registerDiv').classList.add('hidden');
    document.getElementById('loginDiv').classList.remove('hidden');
    document.getElementById('mypageDiv').classList.add('hidden');
}
function showMypage(name) {
    document.getElementById('registerDiv').classList.add('hidden');
    document.getElementById('loginDiv').classList.add('hidden');
    document.getElementById('mypageDiv').classList.remove('hidden');
    document.getElementById('userInfo').innerText = `ようこそ、${name} さん！これはあなた専用のページです。`;
}

// お名前は5文字以上（日本語含む）
function isValidName(name) {
    return name.length >= 3;
}
// パスワードは数字4桁以上
function isValidPw(pw) {
    return /^[0-9]{4,}$/.test(pw);
}

function register() {
    const name = document.getElementById('regName').value.trim();
    const pw = document.getElementById('regPw').value;
    const fileInput = document.getElementById('regFile');
    const msgDiv = document.getElementById('regMsg');

    // 入力チェック
    if (!name || !pw) {
        msgDiv.innerText = 'お名前とログインパスワードを入力してください。';
        return;
    }
    if (!isValidName(name)) {
        msgDiv.innerText = 'お名前は3文字以上で入力してください。';
        return;
    }
    if (!isValidPw(pw)) {
        msgDiv.innerText = 'ログインパスワードは数字4桁以上で入力してください。';
        return;
    }

    let content = '';
    if (fileInput.files.length > 0) {
        // 既存ファイルを読み込む
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            content = e.target.result;
            // 既存お名前の重複チェック
            const lines = content.split('\n');
            for (let line of lines) {
                const [savedName] = line.split(',');
                if (savedName === name) {
                    msgDiv.innerText = 'このお名前は既に登録されています。';
                    return;
                }
            }
            content += `${name},${pw}\n`;
            downloadFile(content);
            msgDiv.innerText = '登録が完了しました。新しいテキストファイルが保存されました。';
            document.getElementById('regName').value = '';
            document.getElementById('regPw').value = '';
        };
        reader.readAsText(file);
    } else {
        // 新規ファイル
        content = `${name},${pw}\n`;
        downloadFile(content);
        msgDiv.innerText = '登録が完了しました。新しいテキストファイルが保存されました。';
        document.getElementById('regName').value = '';
        document.getElementById('regPw').value = '';
    }
}
function downloadFile(content) {
    const blob = new Blob([content], {type: "text/plain"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "accounts.txt";
    link.click();
}
function login() {
    const name = document.getElementById('loginName').value.trim();
    const pw = document.getElementById('loginPw').value;
    const fileInput = document.getElementById('loginFile');
    const msgDiv = document.getElementById('loginMsg');

    // 入力チェック
    if (!name || !pw) {
        msgDiv.innerText = 'お名前とログインパスワードを入力してください。';
        return;
    }
    if (!isValidName(name)) {
        msgDiv.innerText = 'お名前は3文字以上で入力してください。';
        return;
    }
    if (!isValidPw(pw)) {
        msgDiv.innerText = 'ログインパスワードは数字4桁以上で入力してください。';
        return;
    }
    if (fileInput.files.length === 0) {
        msgDiv.innerText = 'テキストファイルを選択してください。';
        return;
    }
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        const lines = content.split('\n');
        let found = false;
        for (let line of lines) {
            const [savedName, savedPw] = line.split(',');
            if (savedName === name && savedPw === pw) {
                found = true;
                break;
            }
        }
        if (found) {
            showMypage(name);
            document.getElementById('loginName').value = '';
            document.getElementById('loginPw').value = '';
            msgDiv.innerText = '';
        } else {
            msgDiv.innerText = 'お名前またはログインパスワードが違います。';
        }
    };
    reader.readAsText(file);
}
function logout() {
    showLogin();
}
window.onload = function() {
    showLogin();
};
</script>
</body>
</html>
